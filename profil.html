<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim - Medikal Estetik Atlasƒ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">üè• Medikal Estetik Atlasƒ±</a>
            <div class="nav-links">
                <a href="/">√úr√ºnler</a>
                <a href="/doktorlar.html">Doktorlar</a>
                <a href="/profil.html" class="active">Profilim</a>
                <button onclick="cikisYap()" class="btn-logout">√áƒ±kƒ±≈ü</button>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="profile-layout">
            <!-- Sol Sidebar -->
            <aside class="profile-sidebar">
                <div class="profile-photo-container">
                    <img id="profilFoto" src="https://via.placeholder.com/150?text=Profil" alt="Profil">
                    <input type="file" id="fotoInput" accept="image/*" style="display:none;" onchange="fotoYukle(this)">
                    <button onclick="document.getElementById('fotoInput').click()" class="change-photo">üì∑ Fotoƒüraf Deƒüi≈ütir</button>
                </div>
                <h2 id="sidebarAd">Kullanƒ±cƒ±</h2>
                <p id="sidebarRol" class="role-badge">-</p>
                
                <nav class="profile-nav">
                    <button onclick="showTab('bilgiler')" id="btn-bilgiler" class="active">Bilgilerim</button>
                    <button onclick="showTab('sifre')" id="btn-sifre">≈ûifre Deƒüi≈ütir</button>
                    <button onclick="showTab('urunler')" id="btn-urunler" style="display:none;">√úr√ºnlerim</button>
                </nav>
            </aside>

            <!-- Saƒü ƒ∞√ßerik -->
            <div class="profile-content">
                
                <!-- Bilgiler Sekmesi -->
                <section id="tab-bilgiler" class="profile-section">
                    <h1>Profil Bilgileri</h1>
                    <form id="profilForm" onsubmit="return profilGuncelle(event)">
                        <div id="profilFormContent"></div>
                        <button type="submit" class="btn-primary">Bilgileri Kaydet</button>
                    </form>
                </section>

                <!-- ≈ûifre Deƒüi≈ütirme Sekmesi -->
                <section id="tab-sifre" class="profile-section" style="display:none;">
                    <h1>≈ûifre Deƒüi≈ütir</h1>
                    <form onsubmit="return sifreDegistir(event)">
                        <div class="form-group">
                            <label>Mevcut ≈ûifre</label>
                            <input type="password" id="mevcutSifre" required>
                        </div>
                        <div class="form-group">
                            <label>Yeni ≈ûifre</label>
                            <input type="password" id="yeniSifre" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Yeni ≈ûifre (Tekrar)</label>
                            <input type="password" id="yeniSifreTekrar" required>
                        </div>
                        <button type="submit" class="btn-primary">≈ûifreyi G√ºncelle</button>
                        <p id="sifreHata" class="error-msg"></p>
                    </form>
                </section>

                <!-- √úr√ºnler Sekmesi (Sadece Firma) -->
                <section id="tab-urunler" class="profile-section" style="display:none;">
                    <h1>√úr√ºnlerim</h1>
                    <button onclick="showUrunModal()" class="btn-secondary">+ Yeni √úr√ºn Ekle</button>
                    <div id="firmaUrunListesi" class="my-products"></div>
                </section>
            </div>
        </div>
    </main>

    <!-- √úr√ºn Ekleme Modalƒ± -->
    <div id="urunModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; overflow-y:auto;">
        <div style="background:white; max-width:800px; margin:50px auto; padding:30px; border-radius:8px; position:relative;">
            <span onclick="hideUrunModal()" style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer;">&times;</span>
            <h2>Yeni √úr√ºn Ekle</h2>
            <form id="urunForm" onsubmit="return urunKaydet(event)">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>√úr√ºn Adƒ± *</label>
                        <input type="text" name="urun_adi" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Kategori *</label>
                        <select name="kategori" required>
                            <option value="toksin">Toksin</option>
                            <option value="dolgu">Dolgu</option>
                            <option value="mezoterapi">Mezoterapi</option>
                            <option value="laser">Laser</option>
                            <option value="sarf">Sarf Malzeme</option>
                            <option value="masa">Masa/Ekipman</option>
                            <option value="cilt-analiz">Cilt Analiz</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Uygulandƒ±ƒüƒ± Alanlar</label>
                        <input type="text" name="uygulama_alanlari">
                    </div>

                    <div class="form-group">
                        <label>Derinlik</label>
                        <input type="text" name="derinlik">
                    </div>

                    <div class="form-group">
                        <label>Etki Ba≈ülangƒ±cƒ±</label>
                        <input type="text" name="etki_baslangici">
                    </div>

                    <div class="form-group">
                        <label>Etki S√ºresi</label>
                        <input type="text" name="etki_suresi">
                    </div>

                    <div class="form-group">
                        <label>Hazƒ±rlanmasƒ±</label>
                        <input type="text" name="hazirlanmasi">
                    </div>

                    <div class="form-group">
                        <label>Saklama Ko≈üullarƒ±</label>
                        <input type="text" name="saklama_kosullari">
                    </div>

                    <div class="form-group">
                        <label>Rekons S√ºresi</label>
                        <input type="text" name="rekons_stresi">
                    </div>

                    <div class="form-group">
                        <label>Teknolojisi</label>
                        <input type="text" name="teknolojisi">
                    </div>

                    <div class="form-group">
                        <label>Endikasyonlar</label>
                        <input type="text" name="endikasyonlar">
                    </div>

                    <div class="form-group">
                        <label>Etkile≈üimler</label>
                        <input type="text" name="etkilesimler">
                    </div>

                    <div class="form-group">
                        <label>Kontrendikasyonlar</label>
                        <input type="text" name="kontrendikasyonlar">
                    </div>

                    <div class="form-group">
                        <label>Class</label>
                        <select name="sinif">
                            <option value="">Se√ßiniz</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>FDA Onayƒ±</label>
                        <select name="fda_onay">
                            <option value="">Se√ßiniz</option>
                            <option value="Onaylƒ±">Onaylƒ±</option>
                            <option value="Onaysƒ±z">Onaysƒ±z</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>CE Belgesi</label>
                        <select name="ce_belgesi">
                            <option value="">Se√ßiniz</option>
                            <option value="Evet">Evet</option>
                            <option value="Hayƒ±r">Hayƒ±r</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>√úTS Kayƒ±t</label>
                        <select name="uts_kayit">
                            <option value="">Se√ßiniz</option>
                            <option value="Evet">Evet</option>
                            <option value="Hayƒ±r">Hayƒ±r</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Kutu Fiyatƒ± (‚Ç∫)</label>
                        <input type="number" name="kutu_fiyati" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Kutu ƒ∞√ßeriƒüi</label>
                        <input type="text" name="kutu_icerigi">
                    </div>

                    <div class="form-group">
                        <label>Adet Fiyatƒ± (‚Ç∫)</label>
                        <input type="number" name="adet_fiyati" step="0.01">
                    </div>

                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Satƒ±n Alma Linki</label>
                        <input type="text" name="satin_alma_linki" placeholder="www.ornek.com veya https://www.ornek.com">
                        <small>http:// veya https:// otomatik eklenir</small>
                    </div>

                    <div class="form-group" style="grid-column:1/-1;">
                        <label>√úr√ºn A√ßƒ±klamasƒ±</label>
                        <textarea name="aciklama" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:20px;">√úr√ºn√º Kaydet</button>
            </form>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script>
        let currentUser = null;
        let userRole = null;

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if(!user) {
                window.location.href = '/giris.html';
                return;
            }
            currentUser = user;
            await loadProfile();
        });

        // Profil bilgilerini y√ºkle
        async function loadProfile() {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if(error) {
                console.error('Profil y√ºklenirken hata:', error);
                return;
            }

            userRole = profile.rol;

            // Sidebar g√ºncelle
            document.getElementById('sidebarRol').textContent = 
                profile.rol === 'admin' ? 'Y√∂netici' : 
                profile.rol === 'firma' ? 'Firma' : 'Doktor';
            
            document.getElementById('sidebarAd').textContent = 
                profile.rol === 'firma' ? profile.firma_adi : profile.ad_soyad;

            if(profile.profil_fotosu) {
                document.getElementById('profilFoto').src = profile.profil_fotosu;
            }

            // Rol bazlƒ± men√º g√∂sterimi
            if(profile.rol === 'firma') {
                document.getElementById('btn-urunler').style.display = 'block';
                loadFirmaUrunleri();
            }

            // Form alanlarƒ±nƒ± doldur
            renderProfileForm(profile);
        }

        // Profil formunu render et
        function renderProfileForm(profile) {
            const container = document.getElementById('profilFormContent');
            
            if(profile.rol === 'firma') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>Firma Adƒ±</label>
                        <input type="text" name="firma_adi" value="${profile.firma_adi || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Vergi No</label>
                        <input type="text" name="vergi_no" value="${profile.vergi_no || ''}">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" name="telefon" value="${profile.telefon || ''}">
                    </div>
                    <div class="form-group">
                        <label>Adres</label>
                        <textarea name="adres">${profile.adres || ''}</textarea>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="form-group">
                        <label>Ad Soyad</label>
                        <input type="text" name="ad_soyad" value="${profile.ad_soyad || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>√únvan</label>
                        <input type="text" name="unvan" value="${profile.unvan || ''}">
                    </div>
                    <div class="form-group">
                        <label>Bran≈ü</label>
                        <input type="text" name="brans" value="${profile.brans || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>ƒ∞lgi Alanlarƒ±</label>
                        <textarea name="ilgi_alanlari" placeholder="√ñrn: Y√ºz estetiƒüi, botox...">${profile.ilgi_alanlari || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>≈ûehir</label>
                        <input type="text" name="sehir" value="${profile.sehir || ''}">
                    </div>
                    <div class="form-group">
                        <label>Adres</label>
                        <textarea name="adres">${profile.adres || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Cep Telefonu</label>
                        <input type="tel" name="telefon" value="${profile.telefon || ''}">
                    </div>
                `;
            }
        }

        // Sekme deƒüi≈ütirme
        function showTab(tabName) {
            // T√ºm sekmeleri gizle
            document.getElementById('tab-bilgiler').style.display = 'none';
            document.getElementById('tab-sifre').style.display = 'none';
            document.getElementById('tab-urunler').style.display = 'none';
            
            // T√ºm butonlardan active sƒ±nƒ±fƒ±nƒ± kaldƒ±r
            document.querySelectorAll('.profile-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Se√ßili sekmeyi g√∂ster
            document.getElementById('tab-' + tabName).style.display = 'block';
            document.getElementById('btn-' + tabName).classList.add('active');
        }

        // Profil g√ºncelleme
        async function profilGuncelle(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const updates = {};
            
            formData.forEach((value, key) => {
                if(value) updates[key] = value;
            });

            const { error } = await supabase
                .from('profiles')
                .update(updates)
                .eq('id', currentUser.id);

            if(error) {
                alert('G√ºncelleme hatasƒ±: ' + error.message);
            } else {
                alert('Profil bilgileri g√ºncellendi!');
                await loadProfile(); // Yeniden y√ºkle
            }
            return false;
        }

        // ≈ûifre deƒüi≈ütirme
        async function sifreDegistir(e) {
            e.preventDefault();
            
            const mevcut = document.getElementById('mevcutSifre').value;
            const yeni = document.getElementById('yeniSifre').value;
            const tekrar = document.getElementById('yeniSifreTekrar').value;
            const hataMsg = document.getElementById('sifreHata');
            
            if(yeni !== tekrar) {
                hataMsg.textContent = 'Yeni ≈üifreler e≈üle≈ümiyor!';
                return false;
            }
            
            const { error } = await supabase.auth.updateUser({ 
                password: yeni 
            });
            
            if(error) {
                hataMsg.textContent = error.message;
            } else {
                alert('≈ûifreniz ba≈üarƒ±yla deƒüi≈ütirildi!');
                e.target.reset();
            }
            return false;
        }

        // Fotoƒüraf y√ºkleme
        async function fotoYukle(input) {
            if(!input.files || input.files.length === 0) return;
            
            const file = input.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
            
            // Storage'a y√ºkle
            const { data, error } = await supabase.storage
                .from('profil-fotolari')
                .upload(fileName, file);
            
            if(error) {
                alert('Fotoƒüraf y√ºklenirken hata: ' + error.message);
                return;
            }
            
            // Public URL al
            const { data: urlData } = supabase.storage
                .from('profil-fotolari')
                .getPublicUrl(fileName);
            
            // Profili g√ºncelle
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ profil_fotosu: urlData.publicUrl })
                .eq('id', currentUser.id);
            
            if(updateError) {
                alert('Profil g√ºncellenirken hata: ' + updateError.message);
            } else {
                document.getElementById('profilFoto').src = urlData.publicUrl;
                alert('Profil fotoƒürafƒ± g√ºncellendi!');
            }
        }

        // Modal kontrolleri
        function showUrunModal() {
            document.getElementById('urunModal').style.display = 'block';
        }

        function hideUrunModal() {
            document.getElementById('urunModal').style.display = 'none';
            document.getElementById('urunForm').reset();
        }

        // √úr√ºn kaydetme
        async function urunKaydet(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                firma_id: currentUser.id,
                urun_adi: formData.get('urun_adi'),
                kategori: formData.get('kategori')
            };

            // URL'yi d√ºzenle (http ekle)
            let link = formData.get('satin_alma_linki');
            if(link && !link.startsWith('http')) {
                link = 'https://' + link;
            }
            data.satin_alma_linki = link;

            // Diƒüer alanlarƒ± ekle (bo≈ü olanlar hari√ß)
            formData.forEach((value, key) => {
                if(value && key !== 'satin_alma_linki' && key !== 'urun_adi' && key !== 'kategori') {
                    data[key] = value;
                }
            });

            const { error } = await supabase.from('urunler').insert([data]);
            
            if(error) {
                alert('√úr√ºn eklenirken hata: ' + error.message);
                console.error(error);
            } else {
                alert('√úr√ºn ba≈üarƒ±yla eklendi!');
                hideUrunModal();
                loadFirmaUrunleri();
            }
            return false;
        }

        // Firma √ºr√ºnlerini listele
        async function loadFirmaUrunleri() {
            const { data: urunler, error } = await supabase
                .from('urunler')
                .select('*')
                .eq('firma_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('firmaUrunListesi');
            
            if(error) {
                container.innerHTML = '<p>Hata olu≈ütu</p>';
                return;
            }

            if(urunler.length === 0) {
                container.innerHTML = '<p>Hen√ºz √ºr√ºn eklenmemi≈ü.</p>';
                return;
            }

            container.innerHTML = urunler.map(u => `
                <div class="product-card">
                    <h3>${u.urun_adi}</h3>
                    <p>Kategori: ${u.kategori}</p>
                    <p>Fiyat: ${u.kutu_fiyati ? '‚Ç∫' + u.kutu_fiyati : '-'}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
