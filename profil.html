<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim - Medikal Estetik Atlasƒ±</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">üè• Medikal Estetik Atlasƒ±</a>
            <div class="nav-links">
                <a href="/">√úr√ºnler</a>
                <a href="/doktorlar.html">Doktorlar</a>
                <a href="/profil.html" class="active">Profilim</a>
                <button onclick="cikisYap()" class="btn-logout">√áƒ±kƒ±≈ü</button>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="profile-layout">
            <aside class="profile-sidebar">
                <div class="profile-photo-container">
                    <img id="profilFoto" src="https://placehold.co/150x150/667eea/ffffff?text=Profil" alt="Profil">
                    <input type="file" id="fotoInput" accept="image/*" style="display:none;">
                    <button onclick="document.getElementById('fotoInput').click()" class="change-photo">üì∑ Fotoƒüraf Deƒüi≈ütir</button>
                </div>
                <h2 id="sidebarAd">Y√ºkleniyor...</h2>
                <p id="sidebarRol" class="role-badge">-</p>
                
                <nav class="profile-nav">
                    <button onclick="showTab('bilgiler')" id="btn-bilgiler" class="active">Bilgilerim</button>
                    <button onclick="showTab('sifre')" id="btn-sifre">≈ûifre Deƒüi≈ütir</button>
                    <button onclick="showTab('urunler')" id="btn-urunler" style="display:none;">√úr√ºnlerim</button>
                </nav>
            </aside>

            <div class="profile-content">
                <section id="tab-bilgiler" class="profile-section">
                    <h1>Profil Bilgileri</h1>
                    <form id="profilForm">
                        <div id="profilFormContent"></div>
                        <button type="submit" class="btn-primary">Bilgileri Kaydet</button>
                    </form>
                </section>

                <section id="tab-sifre" class="profile-section" style="display:none;">
                    <h1>≈ûifre Deƒüi≈ütir</h1>
                    <form id="sifreForm">
                        <div class="form-group">
                            <label>Mevcut ≈ûifre</label>
                            <input type="password" id="mevcutSifre" required>
                        </div>
                        <div class="form-group">
                            <label>Yeni ≈ûifre</label>
                            <input type="password" id="yeniSifre" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>Yeni ≈ûifre (Tekrar)</label>
                            <input type="password" id="yeniSifreTekrar" required>
                        </div>
                        <button type="submit" class="btn-primary">≈ûifreyi G√ºncelle</button>
                        <p id="sifreHata" class="error-msg"></p>
                    </form>
                </section>

                <section id="tab-urunler" class="profile-section" style="display:none;">
                    <h1>√úr√ºnlerim</h1>
                    <button onclick="showUrunModal()" class="btn-secondary">+ Yeni √úr√ºn Ekle</button>
                    <div id="firmaUrunListesi" class="my-products"></div>
                </section>
            </div>
        </div>
    </main>

    <div id="urunModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; overflow-y:auto;">
        <div style="background:white; max-width:800px; margin:50px auto; padding:30px; border-radius:8px; position:relative;">
            <span onclick="hideUrunModal()" style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer;">&times;</span>
            <h2>Yeni √úr√ºn Ekle</h2>
            <form id="urunForm">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-group" style="grid-column:1/-1;">
                        <label>√úr√ºn Adƒ± *</label>
                        <input type="text" name="urun_adi" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Kategori *</label>
                        <select name="kategori" required>
                            <option value="toksin">Toksin</option>
                            <option value="dolgu">Dolgu</option>
                            <option value="mezoterapi">Mezoterapi</option>
                            <option value="laser">Laser</option>
                            <option value="sarf">Sarf Malzeme</option>
                            <option value="masa">Masa/Ekipman</option>
                            <option value="cilt-analiz">Cilt Analiz</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Uygulandƒ±ƒüƒ± Alanlar</label>
                        <input type="text" name="uygulama_alanlari">
                    </div>

                    <div class="form-group">
                        <label>Derinlik</label>
                        <input type="text" name="derinlik">
                    </div>

                    <div class="form-group">
                        <label>Etki Ba≈ülangƒ±cƒ±</label>
                        <input type="text" name="etki_baslangici">
                    </div>

                    <div class="form-group">
                        <label>Etki S√ºresi</label>
                        <input type="text" name="etki_suresi">
                    </div>

                    <div class="form-group">
                        <label>Hazƒ±rlanmasƒ±</label>
                        <input type="text" name="hazirlanmasi">
                    </div>

                    <div class="form-group">
                        <label>Saklama Ko≈üullarƒ±</label>
                        <input type="text" name="saklama_kosullari">
                    </div>

                    <div class="form-group">
                        <label>Rekons S√ºresi</label>
                        <input type="text" name="rekons_stresi">
                    </div>

                    <div class="form-group">
                        <label>Teknolojisi</label>
                        <input type="text" name="teknolojisi">
                    </div>

                    <div class="form-group">
                        <label>Endikasyonlar</label>
                        <input type="text" name="endikasyonlar">
                    </div>

                    <div class="form-group">
                        <label>Etkile≈üimler</label>
                        <input type="text" name="etkilesimler">
                    </div>

                    <div class="form-group">
                        <label>Kontrendikasyonlar</label>
                        <input type="text" name="kontrendikasyonlar">
                    </div>

                    <div class="form-group">
                        <label>Class</label>
                        <select name="sinif">
                            <option value="">Se√ßiniz</option>
                            <option value="1">Class 1</option>
                            <option value="2">Class 2</option>
                            <option value="3">Class 3</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>FDA Onayƒ±</label>
                        <select name="fda_onay">
                            <option value="">Se√ßiniz</option>
                            <option value="Onaylƒ±">Onaylƒ±</option>
                            <option value="Onaysƒ±z">Onaysƒ±z</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>CE Belgesi</label>
                        <select name="ce_belgesi">
                            <option value="">Se√ßiniz</option>
                            <option value="Evet">Evet</option>
                            <option value="Hayƒ±r">Hayƒ±r</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>√úTS Kayƒ±t</label>
                        <select name="uts_kayit">
                            <option value="">Se√ßiniz</option>
                            <option value="Evet">Evet</option>
                            <option value="Hayƒ±r">Hayƒ±r</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Kutu Fiyatƒ± (‚Ç∫)</label>
                        <input type="number" name="kutu_fiyati" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Kutu ƒ∞√ßeriƒüi</label>
                        <input type="text" name="kutu_icerigi">
                    </div>

                    <div class="form-group">
                        <label>Adet Fiyatƒ± (‚Ç∫)</label>
                        <input type="number" name="adet_fiyati" step="0.01">
                    </div>

                    <div class="form-group" style="grid-column:1/-1;">
                        <label>Satƒ±n Alma Linki</label>
                        <input type="text" name="satin_alma_linki" placeholder="www.ornek.com">
                        <small>http:// otomatik eklenir</small>
                    </div>

                    <div class="form-group" style="grid-column:1/-1;">
                        <label>√úr√ºn A√ßƒ±klamasƒ±</label>
                        <textarea name="aciklama" rows="3"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:20px;">√úr√ºn√º Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userRole = null;

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase kontrol√º
            if(typeof supabase === 'undefined') {
                alert('Sistem y√ºklenirken hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.');
                return;
            }
            
            const { data: { user } } = await supabase.auth.getUser();
            if(!user) {
                window.location.href = '/giris.html';
                return;
            }
            currentUser = user;
            await loadProfile();
            
            // Event listenerlarƒ± baƒüla
            document.getElementById('profilForm').addEventListener('submit', profilGuncelle);
            document.getElementById('sifreForm').addEventListener('submit', sifreDegistir);
            document.getElementById('urunForm').addEventListener('submit', urunKaydet);
            document.getElementById('fotoInput').addEventListener('change', function() { fotoYukle(this); });
        });

        // Profil y√ºkle
        async function loadProfile() {
            if(!currentUser) return;
            
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if(error || !profile) {
                console.error('Profil y√ºklenirken hata:', error);
                return;
            }

            userRole = profile.rol;
            
            document.getElementById('sidebarRol').textContent = 
                profile.rol === 'admin' ? 'Y√∂netici' : 
                profile.rol === 'firma' ? 'Firma Sahibi' : 'Doktor';
            
            document.getElementById('sidebarAd').textContent = 
                profile.rol === 'firma' ? (profile.firma_adi || 'Firma') : (profile.ad_soyad || 'Kullanƒ±cƒ±');

            if(profile.profil_fotosu) {
                document.getElementById('profilFoto').src = profile.profil_fotosu;
            }

            if(profile.rol === 'firma') {
                document.getElementById('btn-urunler').style.display = 'block';
                loadFirmaUrunleri();
            }

            renderProfileForm(profile);
        }

        function renderProfileForm(profile) {
            const container = document.getElementById('profilFormContent');
            
            if(profile.rol === 'firma') {
                container.innerHTML = `
                    <div class="form-group">
                        <label>Firma Adƒ±</label>
                        <input type="text" name="firma_adi" value="${profile.firma_adi || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Vergi No</label>
                        <input type="text" name="vergi_no" value="${profile.vergi_no || ''}">
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" name="telefon" value="${profile.telefon || ''}">
                    </div>
                    <div class="form-group">
                        <label>Adres</label>
                        <textarea name="adres">${profile.adres || ''}</textarea>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="form-group">
                        <label>Ad Soyad</label>
                        <input type="text" name="ad_soyad" value="${profile.ad_soyad || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>√únvan</label>
                        <input type="text" name="unvan" value="${profile.unvan || ''}">
                    </div>
                    <div class="form-group">
                        <label>Bran≈ü</label>
                        <input type="text" name="brans" value="${profile.brans || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>ƒ∞lgi Alanlarƒ±</label>
                        <textarea name="ilgi_alanlari">${profile.ilgi_alanlari || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>≈ûehir</label>
                        <input type="text" name="sehir" value="${profile.sehir || ''}">
                    </div>
                    <div class="form-group">
                        <label>Adres</label>
                        <textarea name="adres">${profile.adres || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" name="telefon" value="${profile.telefon || ''}">
                    </div>
                `;
            }
        }

        function showTab(tabName) {
            document.getElementById('tab-bilgiler').style.display = 'none';
            document.getElementById('tab-sifre').style.display = 'none';
            document.getElementById('tab-urunler').style.display = 'none';
            document.querySelectorAll('.profile-nav button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).style.display = 'block';
            document.getElementById('btn-' + tabName).classList.add('active');
        }

        async function profilGuncelle(e) {
            e.preventDefault();
            if(!currentUser) return;
            
            const formData = new FormData(e.target);
            const updates = {};
            formData.forEach((value, key) => { if(value) updates[key] = value; });

            const { error } = await supabase.from('profiles').update(updates).eq('id', currentUser.id);

            if(error) {
                alert('G√ºncelleme hatasƒ±: ' + error.message);
            } else {
                alert('Profil bilgileri g√ºncellendi!');
                await loadProfile();
            }
        }

        async function sifreDegistir(e) {
            e.preventDefault();
            
            const mevcut = document.getElementById('mevcutSifre').value;
            const yeni = document.getElementById('yeniSifre').value;
            const tekrar = document.getElementById('yeniSifreTekrar').value;
            
            if(yeni !== tekrar) {
                document.getElementById('sifreHata').textContent = '≈ûifreler e≈üle≈ümiyor!';
                return;
            }
            
            const { error } = await supabase.auth.updateUser({ password: yeni });
            if(error) {
                document.getElementById('sifreHata').textContent = error.message;
            } else {
                alert('≈ûifre deƒüi≈ütirildi!');
                e.target.reset();
            }
        }

        async function fotoYukle(input) {
            if(!input.files || input.files.length === 0 || !currentUser) return;
            
            const file = input.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
            
            const { data, error } = await supabase.storage.from('profil-fotolari').upload(fileName, file);
            if(error) { alert('Y√ºkleme hatasƒ±: ' + error.message); return; }
            
            const { data: urlData } = supabase.storage.from('profil-fotolari').getPublicUrl(fileName);
            await supabase.from('profiles').update({ profil_fotosu: urlData.publicUrl }).eq('id', currentUser.id);
            
            document.getElementById('profilFoto').src = urlData.publicUrl;
            alert('Fotoƒüraf g√ºncellendi!');
        }

        function showUrunModal() { document.getElementById('urunModal').style.display = 'block'; }
        function hideUrunModal() { 
            document.getElementById('urunModal').style.display = 'none'; 
            document.getElementById('urunForm').reset();
        }

        async function urunKaydet(e) {
            e.preventDefault();
            if(!currentUser) return;
            
            const formData = new FormData(e.target);
            const data = {
                firma_id: currentUser.id,
                urun_adi: formData.get('urun_adi'),
                kategori: formData.get('kategori')
            };

            let link = formData.get('satin_alma_linki');
            if(link && !link.startsWith('http')) link = 'https://' + link;
            data.satin_alma_linki = link;

            formData.forEach((value, key) => {
                if(value && !data[key] && key !== 'urun_adi' && key !== 'kategori' && key !== 'satin_alma_linki') {
                    data[key] = value;
                }
            });

            const { error } = await supabase.from('urunler').insert([data]);
            if(error) { alert('Hata: ' + error.message); }
            else { 
                alert('√úr√ºn eklendi!'); 
                hideUrunModal(); 
                loadFirmaUrunleri(); 
            }
        }

        async function loadFirmaUrunleri() {
            if(!currentUser) return;
            
            const { data: urunler, error } = await supabase
                .from('urunler').select('*').eq('firma_id', currentUser.id).order('created_at', { ascending: false });

            const container = document.getElementById('firmaUrunListesi');
            if(error) { container.innerHTML = '<p>Hata</p>'; return; }
            if(urunler.length === 0) { container.innerHTML = '<p>Hen√ºz √ºr√ºn yok.</p>'; return; }

            container.innerHTML = urunler.map(u => `
                <div class="product-card" style="margin-bottom:15px; padding:15px; border:1px solid #ddd; border-radius:8px;">
                    <h3>${u.urun_adi}</h3>
                    <p>Kategori: ${u.kategori}</p>
                    ${u.kutu_fiyati ? '<p>Fiyat: ‚Ç∫' + u.kutu_fiyati + '</p>' : ''}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
